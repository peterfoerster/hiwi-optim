\subsection{Geometry}
The $200$ kV geometry was derived from version one of the CST model. Some simplifications were made such that the geometry may be considered rotationally symmetric. The dimensions of the electrode, puck, puck elevator, vacuum chamber and insulator were derived from the model as depicted in fig.~\ref{fig:cst_geometry_yz}. The boundary conditions remained the same, except for the increase in voltage, when compared to the $60$ kV variant and the relative permittivity of the insulator was taken from the $60$ kV model to be $9.4$.

The geometry is depicted in fig.~\ref{fig:200kV_geometry_v1}. The numbers refer to the individual patches in the context of IGA. The patch boundaries are indicated by grey lines. The red lines represent homogeneous Dirichlet boundary conditions, the blue lines inhomogeneous Dirichlet boundary conditions with a value of $-200$ kV and the black lines indicate homogeneous Neumann boundaries.
The patches containing insulator material are colored in red and the blue patch indicates the part of the electrode boundary where the holes would be positioned.

The holes depicted in fig.~\ref{fig:cst_geometry_xz} are neglected in the current version of the model to obtain rotational symmetry for the geometry. However their volume will be taken into account later for the volume constraint.

We also observe triple points within the computational domain. These are defined by material boundaries between air/vacuum, steel and the insulator.

\begin{center}
\begin{figure}[H]
   \begin{subfigure}{0.45\textwidth}
      \includegraphics[width=\textwidth]{figures/200kV/png/v1_cutx}
      \caption{$y$-$z$ view for $x=0$.}
      \label{fig:cst_geometry_yz}
   \end{subfigure}
   \begin{subfigure}{0.45\textwidth}
      \includegraphics[width=\textwidth]{figures/200kV/png/v1_cuty}
      \caption{$x$-$z$ view for $y=0$.}
      \label{fig:cst_geometry_xz}
   \end{subfigure}
   \caption{CST model. For the computation of the electric scalar potential the holes seen in the right figure are neglected to obtain axisymmetry.}
\end{figure}
\end{center}

\begin{center}
\begin{figure}[H]
  \input{figures/200kV/geometry_v1}
  \caption{200 kV Photocathode geometry and boundary conditions. The blue lines indicate homogeneous Dirichlet conditions, the red lines represent inhomogeneous Dirichlet boundary conditions with a value of $-200$ kV and the black lines indicate homogeneous Neumann boundaries. The lower boundary of the orange patch is used to compute the volume of the holes for the volume constraint. The grey patches indicate insulator material with a relative permittivity of $9.4$.}
  \label{fig:200kV_geometry_v1}
\end{figure}
\end{center}

\subsection{Electric Field}
The solution for the electric field is shown in fig.~\ref{fig:200kV_electric_field}.
It was computed with $p=3$ as the degree of the basis functions and $n_\mathrm{sub}=16$ as the number of elements that each knot vector is uniformly split into. The fairly low number of subdomains was chosen to improve performance in regards to the optimization.
It is evident that there exist parts of the domain where the magnitude of the electric field is close to the limit of $10 \frac{\mathrm{MV}}{\mathrm{m}}$. There are also very high gradients visible at the triple points, however these also coincide with sharp corners so numerical issues might play a role.

\begin{center}
\begin{figure}[H]
  \includegraphics[width=\textwidth]{figures/200kV/png/order=3}
  \caption{Absolute value of the electric field with $p=3$ and $n_\mathrm{sub}=16$.}
  \label{fig:200kV_electric_field}
\end{figure}
\end{center}

\subsection{Optimization}
The aim of the optimization is to minimize the maximal field amplitudes. For practicality we will only look at the critical points of the geometry, i.~e.~the curvatures of the outer electrode and the triple points. The lower part of the geometry will remain fixed so only the electrode boundaries of patches 5 through 11 from fig.~\ref{fig:200kV_geometry_v1} and their respective control points are the DoFs. Aside from the fixed part of the geometry we also consider a volume constraint.

\subsubsection{Volume Constraint}
One of the constraints for the optimization is the weight of the electrode and thus its volume.
We first compute the volume of the patches by taking into account the rotational symmetry and discretizing $V_{\mathrm{ptc}} = \int_V r\, \drm r\, \drm \varphi\, \drm z$ via numerical quadrature. We can then obtain the volume of the electrode by subtracting $V_{\mathrm{ptc}}$ from the cylinder formed by the vacuumchamber.
We still need to consider the holes inside the electrode, visible in \ref{fig:cst_geometry_xz}. Their volume is computed by considering a cylinder with its height as a function of $z$. The curvature in $x$ and $y$ is disregarded, since it is the same for both coordinates. We can therefore determine the value by discretizing $V_{h} = \int_V \drm x\, \drm y\, \drm z$.
Lastly the connection of the electrode with the insulator as well as the lift and the connection to the cable are not part of the electrode and thus their volume is subtracted as well.
In total the physical constraint is set at $625\ \mathrm{cm}^3$ and the volume of the current geometry is computed as approximately $608\ \mathrm{cm}^3$.

\subsubsection{Cost Function}
For the cost function we first define $E_i$ as the maximal absolute electric field across the quadrature nodes of patch $i$.
We then define the cost function to be
\begin{align}
   c = \frac{1}{|I|} \sum_{i \in I} E_i
\end{align}
where $I$ contains the indices of the patches of interest.

\subsubsection{Additional Constraints}
As an additional constraint we require $C^1$ continuity of the section that is optimized. The starting nurbs is depicted in fig.~\ref{fig:nurbs}. Furthermore the control points, which represent the DoFs, are constrained to stay inside their respective patch boundaries and in the correct order. To correctly model the holes with patch 8 the adjacent control points are constrained to only move vertically.

\begin{center}
\begin{figure}[H]
  \input{figures/200kV/nurbs}
  \caption{$C^1$ continuous nurbs that is to be optimized including the variable control points which represent the DoFs.}
  \label{fig:nurbs}
\end{figure}
\end{center}

\subsubsection{NLopt}
For the optimization we used implementations of BOBYQA and COBYLA as given by the NLopt libary. For now we selected to use COBYLA as it is able to directly handle nonlinear constraints whereas they need to be enforced using an augmented Lagrangian method for BOBYQA.

\subsubsection{Results}
The results obtained from the optimization are depicted in fig.~\ref{fig:results_iga}. For the cost function we chose $I=\{ 6, \dotsc, 11 \}$. The new geometry has a volume of about 625 $\mathrm{cm}^3$. The original value of the cost function was 6.2 $\frac{\mathrm{MV}}{\mathrm{m}}$ and the optimized one is 5.3 $\frac{\mathrm{MV}}{\mathrm{m}}$. The absolute maximum value in any of the quadrature points was 7.7 $\frac{\mathrm{MV}}{\mathrm{m}}$ to begin with and ended up at 6.1 $\frac{\mathrm{MV}}{\mathrm{m}}$.

\begin{center}
\begin{figure}[H]
  \includegraphics[width=\textwidth]{figures/200kV/png/cobyla_run11}
  \caption{Optimization result using COBYLA with $I=\{ 6, \dots, 11 \}$.}
  \label{fig:results_iga}
\end{figure}
\end{center}

In order to compare the results with the original geometry and simulation the optimized geometry was also imported and simulated in CST. The results indicate a clear improvement from the optimized geometry over the original one. This is in agreement with the numerical improvement observed in the context of IGA.

\begin{center}
\begin{figure}[H]
   \begin{subfigure}{0.45\textwidth}
      \includegraphics[width=\textwidth]{figures/200kV/cst/efield_orig_mesh}
   \end{subfigure}
   \begin{subfigure}{0.45\textwidth}
      \includegraphics[width=\textwidth]{figures/200kV/cst/efield_mesh_new}
   \end{subfigure}
   \caption{Mesh of original and optimized geometry in CST.}
\end{figure}
\end{center}

\begin{center}
\begin{figure}[H]
   \begin{subfigure}{0.45\textwidth}
      \includegraphics[width=\textwidth]{figures/200kV/cst/efield_orig}
   \end{subfigure}
   \begin{subfigure}{0.45\textwidth}
      \includegraphics[width=\textwidth]{figures/200kV/cst/efield_insulator_new}
   \end{subfigure}
   \caption{Results of original and optimized geometry in CST.}
\end{figure}
\end{center}

\subsection{Questions}
\begin{itemize}
   \item should we consider the field strength in the insulator
   \item what is the relative permittivity of the insulator
   \item which part of the geometry should be optimized and why
   \item are the holes open during operation, should we consider them during optimization (3D simulation)
   \item what material does the dielectric strength of 10 MV/m refer to
\end{itemize}

\subsection{Astra}
In the future we may also optimize the electrode boundary next to the puck, i.~e.~patches 3, 4 and 5 to obtain optimal particle trajectories. The cost function will be computed using Astra.
The desired total bunch charge is $10$ pC with a beam current of $(20-100)\ \mu\mathrm{A}$, whereas a typical value would be $100$ fC. The bunch length is around $5$ ps with a normalized transversal emittance of $e_{x,y} \leq 1\ \mathrm{mm\: mrad}$. The desired energy resolution is $\frac{\Delta E}{E} \leq 10^{-4}$.
The tracking will be performed using individual bunches from a pulsed laser. The emission model may be derived from \cite{wagner}.
